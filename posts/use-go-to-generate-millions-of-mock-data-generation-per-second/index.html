<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>使用 Go 语言每秒百万量级的模拟数据生成优化总结 | 一只麻酱</title><meta name=keywords content="Go"><meta name=description content="本文旨在深入研究如何使用Go语言优化模拟数据生成性能。我们将介绍三个不同版本的代码实现，并详细分析它们的性能和优点。
版本一：基础实现 首先，让我们来看看第一个版本的代码，这是一个基础实现，没有引入并发。以下是版本一的核心代码：
func randomVersion1(labels []int) *strings.Builder { str := &strings.Builder{} for i := 0; i < len(labels); i++ { switch labels[i] { case 0: str.WriteString(strconv.Itoa(rand.Intn(2) - 1)) case 1: str.WriteString(fmt.Sprintf(&#34;%.8f&#34;, 0.1+rand.Float64()*(1-0.1))) } if i < len(labels)-1 { str.WriteString(&#34;,&#34;) } } return str } func TestVersion1(t *testing.T) { f, _ := os.OpenFile(filename, os.O_CREATE|os.O_RDWR|os.O_TRUNC, 0644) buf := bufio.NewWriter(f) s := time.Now() buf.WriteString(fmt.Sprintf(&#34;%s\n&#34;, header)) for i := 0; i < 1000000; i++ { buf."><meta name=author content="Mioto Yaku"><link rel=canonical href=https://mioto.me/posts/use-go-to-generate-millions-of-mock-data-generation-per-second/><link crossorigin=anonymous href=/assets/css/stylesheet.5cfc680b1eeaeef9efbced92d46c2a9e876b72ee14fba85846afc4cff9e6e6f8.css integrity="sha256-XPxoCx7q7vnvvO2S1Gwqnodrcu4U+6hYRq/Ez/nm5vg=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://mioto.me/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://mioto.me/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://mioto.me/favicon-32x32.png><link rel=apple-touch-icon href=https://mioto.me/apple-touch-icon.png><link rel=mask-icon href=https://mioto.me/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-102233768-1","auto"),ga("send","pageview"))</script><meta property="og:title" content="使用 Go 语言每秒百万量级的模拟数据生成优化总结"><meta property="og:description" content="本文旨在深入研究如何使用Go语言优化模拟数据生成性能。我们将介绍三个不同版本的代码实现，并详细分析它们的性能和优点。
版本一：基础实现 首先，让我们来看看第一个版本的代码，这是一个基础实现，没有引入并发。以下是版本一的核心代码：
func randomVersion1(labels []int) *strings.Builder { str := &strings.Builder{} for i := 0; i < len(labels); i++ { switch labels[i] { case 0: str.WriteString(strconv.Itoa(rand.Intn(2) - 1)) case 1: str.WriteString(fmt.Sprintf(&#34;%.8f&#34;, 0.1+rand.Float64()*(1-0.1))) } if i < len(labels)-1 { str.WriteString(&#34;,&#34;) } } return str } func TestVersion1(t *testing.T) { f, _ := os.OpenFile(filename, os.O_CREATE|os.O_RDWR|os.O_TRUNC, 0644) buf := bufio.NewWriter(f) s := time.Now() buf.WriteString(fmt.Sprintf(&#34;%s\n&#34;, header)) for i := 0; i < 1000000; i++ { buf."><meta property="og:type" content="article"><meta property="og:url" content="https://mioto.me/posts/use-go-to-generate-millions-of-mock-data-generation-per-second/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-09-25T10:30:23+08:00"><meta property="article:modified_time" content="2021-09-25T10:30:23+08:00"><meta property="og:site_name" content="一只麻酱"><meta name=twitter:card content="summary"><meta name=twitter:title content="使用 Go 语言每秒百万量级的模拟数据生成优化总结"><meta name=twitter:description content="本文旨在深入研究如何使用Go语言优化模拟数据生成性能。我们将介绍三个不同版本的代码实现，并详细分析它们的性能和优点。
版本一：基础实现 首先，让我们来看看第一个版本的代码，这是一个基础实现，没有引入并发。以下是版本一的核心代码：
func randomVersion1(labels []int) *strings.Builder { str := &strings.Builder{} for i := 0; i < len(labels); i++ { switch labels[i] { case 0: str.WriteString(strconv.Itoa(rand.Intn(2) - 1)) case 1: str.WriteString(fmt.Sprintf(&#34;%.8f&#34;, 0.1+rand.Float64()*(1-0.1))) } if i < len(labels)-1 { str.WriteString(&#34;,&#34;) } } return str } func TestVersion1(t *testing.T) { f, _ := os.OpenFile(filename, os.O_CREATE|os.O_RDWR|os.O_TRUNC, 0644) buf := bufio.NewWriter(f) s := time.Now() buf.WriteString(fmt.Sprintf(&#34;%s\n&#34;, header)) for i := 0; i < 1000000; i++ { buf."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://mioto.me/posts/"},{"@type":"ListItem","position":3,"name":"使用 Go 语言每秒百万量级的模拟数据生成优化总结","item":"https://mioto.me/posts/use-go-to-generate-millions-of-mock-data-generation-per-second/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"使用 Go 语言每秒百万量级的模拟数据生成优化总结","name":"使用 Go 语言每秒百万量级的模拟数据生成优化总结","description":"本文旨在深入研究如何使用Go语言优化模拟数据生成性能。我们将介绍三个不同版本的代码实现，并详细分析它们的性能和优点。\n版本一：基础实现 首先，让我们来看看第一个版本的代码，这是一个基础实现，没有引入并发。以下是版本一的核心代码：\nfunc randomVersion1(labels []int) *strings.Builder { str := \u0026amp;strings.Builder{} for i := 0; i \u0026lt; len(labels); i++ { switch labels[i] { case 0: str.WriteString(strconv.Itoa(rand.Intn(2) - 1)) case 1: str.WriteString(fmt.Sprintf(\u0026#34;%.8f\u0026#34;, 0.1+rand.Float64()*(1-0.1))) } if i \u0026lt; len(labels)-1 { str.WriteString(\u0026#34;,\u0026#34;) } } return str } func TestVersion1(t *testing.T) { f, _ := os.OpenFile(filename, os.O_CREATE|os.O_RDWR|os.O_TRUNC, 0644) buf := bufio.NewWriter(f) s := time.Now() buf.WriteString(fmt.Sprintf(\u0026#34;%s\\n\u0026#34;, header)) for i := 0; i \u0026lt; 1000000; i++ { buf.","keywords":["Go"],"articleBody":"本文旨在深入研究如何使用Go语言优化模拟数据生成性能。我们将介绍三个不同版本的代码实现，并详细分析它们的性能和优点。\n版本一：基础实现 首先，让我们来看看第一个版本的代码，这是一个基础实现，没有引入并发。以下是版本一的核心代码：\nfunc randomVersion1(labels []int) *strings.Builder { str := \u0026strings.Builder{} for i := 0; i \u003c len(labels); i++ { switch labels[i] { case 0: str.WriteString(strconv.Itoa(rand.Intn(2) - 1)) case 1: str.WriteString(fmt.Sprintf(\"%.8f\", 0.1+rand.Float64()*(1-0.1))) } if i \u003c len(labels)-1 { str.WriteString(\",\") } } return str } func TestVersion1(t *testing.T) { f, _ := os.OpenFile(filename, os.O_CREATE|os.O_RDWR|os.O_TRUNC, 0644) buf := bufio.NewWriter(f) s := time.Now() buf.WriteString(fmt.Sprintf(\"%s\\n\", header)) for i := 0; i \u003c 1000000; i++ { buf.WriteString(fmt.Sprintf(\"%d,%s\\n\", i, randomVersion1(labels).String())) } fmt.Println(\"version1 use time: \", time.Since(s)) } 版本一的特点： 使用 strings.Builder 和 bufio.Writer 进行字符串和文件操作，以提高性能。 利用 os.OpenFile 和 bufio.NewWriter 来进行文件操作，确保高效且安全。 版本二：引入并发 接下来，我们将介绍版本二的代码，它引入了并发处理，通过协程和通道来提高性能。以下是版本二的核心代码示例：\nfunc randomVersion2(labels []int, columnCh chan *strings.Builder) { str := \u0026strings.Builder{} for i := 0; i \u003c len(labels); i++ { switch labels[i] { case 0: str.WriteString(strconv.Itoa(rand.Intn(2) - 1)) case 1: str.WriteString(fmt.Sprintf(\"%.8f\", 0.1+rand.Float64()*(1-0.1))) } if i \u003c len(labels)-1 { str.WriteString(\",\") } } columnCh \u003c- str } func TestVersion2(t *testing.T) { f, _ := os.OpenFile(filename, os.O_CREATE|os.O_RDWR|os.O_TRUNC, 0644) buf := bufio.NewWriter(f) s := time.Now() buf.WriteString(fmt.Sprintf(\"%s\\n\", header)) columCh := make(chan *strings.Builder, 2000) countCh := make(chan int) wg := sync.WaitGroup{} worker := func(n chan int) { for { _, ok := \u003c-n if !ok { wg.Done() return } randomVersion2(labels, columCh) } } for i := 0; i \u003c runtime.NumCPU()*2; i++ { wg.Add(1) go worker(countCh) } go func() { for i := 0; i \u003c 1000000; i++ { countCh \u003c- i } close(countCh) }() for i := 0; i \u003c 1000000; i++ { colum, ok := \u003c-columCh if !ok { return } buf.WriteString(fmt.Sprintf(\"%d,%s\\n\", i, colum.String())) } fmt.Println(\"version2 use time: \", time.Since(s)) } 版本二的优势 卓越的性能：通过并发，版本二在多核 CPU 上表现出色。 最大程度地利用系统资源：根据CPU核心数创建工作线程，更有效地管理资源。 优越的扩展性：使用工作队列和协程模型，易于扩展。 精确的任务管理：结合 sync.WaitGroup 和通道，确保任务的准确执行。 增强的吞吐量：通过使用缓冲通道，提高性能。 版本三：进一步优化 版本三对性能和内存效率进行了更深层次的优化，引入了自定义随机源和对象池。以下是版本三的核心代码示例：\ntype randSource struct { rand.Source } func (r *randSource) Float64() float64 { // Change from Go 1 -- make results be uniform. return (float64(r.Int63() \u003e\u003e 10)) * (1.0 / 9007199254740992.0) } func (r *randSource) Int() int64 { // Change from Go 1 -- make results be uniform. return r.Int63() % 2 } func randomVersion2(labels []int, columnCh chan *strings.Builder) { str := \u0026strings.Builder{} for i := 0; i \u003c len(labels); i++ { switch labels[i] { case 0: str.WriteString(strconv.Itoa(rand.Intn(2) - 1)) case 1: str.WriteString(fmt.Sprintf(\"%.8f\", 0.1+rand.Float64()*(1-0.1))) } if i \u003c len(labels)-1 { str.WriteString(\",\") } } columnCh \u003c- str } func TestVersion3(t *testing.T) { poolBuilder := sync.Pool{ New: func() interface{} { return bytes.NewBuffer(make([]byte, 0, 4096)) }, } poolBuf := sync.Pool{ New: func() interface{} { return make([]byte, 0, 8) }, } wg := sync.WaitGroup{} count := 1000000 countCh := make(chan int) columCh := make(chan *bytes.Buffer, 2000) random := func(labels []int, r *randSource, columCh chan *bytes.Buffer) { str := poolBuilder.Get().(*bytes.Buffer) buf := poolBuf.Get().([]byte) for i := 0; i \u003c len(labels); i++ { switch labels[i] { case 0: str.Write(strconv.AppendInt(buf, r.Int(), 10)) case 1: str.Write(strconv.AppendFloat(buf, r.Float64(), 'f', 8, 64)) } if i \u003c len(labels)-1 { str.WriteByte(',') } } poolBuf.Put(buf) columCh \u003c- str } f, _ := os.OpenFile(filename, os.O_CREATE|os.O_RDWR|os.O_TRUNC, 0644) buf := bufio.NewWriter(f) s := time.Now() buf.WriteString(fmt.Sprintf(\"%s\\n\", header)) worker := func(n chan int) { r := \u0026randSource{ Source: rand.NewSource(rand.Int63()), } for { _, ok := \u003c-n if !ok { wg.Done() return } random(labels, r, columCh) } } for i := 0; i \u003c runtime.NumCPU()*2; i++ { wg.Add(1) go worker(countCh) } for i := 0; i \u003c runtime.NumCPU()*2; i++ { wg.Add(1) go worker(countCh) } go func() { for i := 0; i \u003c count; i++ { countCh \u003c- i } close(countCh) }() for i := 0; i \u003c count; i++ { colum, ok := \u003c-columCh if !ok { return } b := poolBuf.Get().([]byte) buf.Write(strconv.AppendInt(b, int64(i), 10)) buf.WriteByte(',') buf.Write(colum.Bytes()) buf.WriteByte('\\n') colum.Reset() poolBuilder.Put(colum) poolBuf.Put(b) } buf.Flush() f.Close() fmt.Println(\"version3 use time:\", time.Since(s)) } Go代码：TestVersion3 函数与 randomVersion2 函数的区别和优势 减少内存占用：使用 sync.Pool 重用内存，有效降低GC负担。 改进性能：借助字节操作和缓冲，提高性能。 更高的并发性：通过增加工作线程数量，充分发挥多核CPU的威力。 更精确的随机数生成：自定义随机数源生成更均匀的随机数，无需竞争全局锁。 优化的代码结构：将随机数生成逻辑封装在函数中，提高代码的可维护性和可重用性。 更快的数据写入：借助字节操作和缓冲，提高数据写入速度。 全局锁的区别：在版本三中，我们引入了自定义的 randSource 结构，并重写了 Float64 和 Int 方法，以自定义随机数生成的方式。通过这种方式，我们无需竞争 rand 包的全局锁，从而避免了在多线程环境下可能出现的性能瓶颈。 通过这些改进，TestVersion3在性能、内存效率和可扩展性方面都有明显的优势。\n","wordCount":"603","inLanguage":"zh","datePublished":"2021-09-25T10:30:23+08:00","dateModified":"2021-09-25T10:30:23+08:00","author":{"@type":"Person","name":"Mioto Yaku"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://mioto.me/posts/use-go-to-generate-millions-of-mock-data-generation-per-second/"},"publisher":{"@type":"Organization","name":"一只麻酱","logo":{"@type":"ImageObject","url":"https://mioto.me/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://mioto.me accesskey=h title="一只麻酱 (Alt + H)">一只麻酱</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://mioto.me/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://mioto.me/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>使用 Go 语言每秒百万量级的模拟数据生成优化总结</h1><div class=post-meta><span title='2021-09-25 10:30:23 +0800 +0800'>九月 25, 2021</span>&nbsp;·&nbsp;3 分钟&nbsp;·&nbsp;Mioto Yaku</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#%e7%89%88%e6%9c%ac%e4%b8%80%e5%9f%ba%e7%a1%80%e5%ae%9e%e7%8e%b0 aria-label=版本一：基础实现>版本一：基础实现</a><ul><li><a href=#%e7%89%88%e6%9c%ac%e4%b8%80%e7%9a%84%e7%89%b9%e7%82%b9 aria-label=版本一的特点：>版本一的特点：</a></li></ul></li><li><a href=#%e7%89%88%e6%9c%ac%e4%ba%8c%e5%bc%95%e5%85%a5%e5%b9%b6%e5%8f%91 aria-label=版本二：引入并发>版本二：引入并发</a><ul><li><a href=#%e7%89%88%e6%9c%ac%e4%ba%8c%e7%9a%84%e4%bc%98%e5%8a%bf aria-label=版本二的优势>版本二的优势</a></li></ul></li><li><a href=#%e7%89%88%e6%9c%ac%e4%b8%89%e8%bf%9b%e4%b8%80%e6%ad%a5%e4%bc%98%e5%8c%96 aria-label=版本三：进一步优化>版本三：进一步优化</a><ul><ul><li><a href=#go%e4%bb%a3%e7%a0%81testversion3-%e5%87%bd%e6%95%b0%e4%b8%8e-randomversion2-%e5%87%bd%e6%95%b0%e7%9a%84%e5%8c%ba%e5%88%ab%e5%92%8c%e4%bc%98%e5%8a%bf aria-label="Go代码：TestVersion3 函数与 randomVersion2 函数的区别和优势">Go代码：<code>TestVersion3</code> 函数与 <code>randomVersion2</code> 函数的区别和优势</a></li></ul></ul></li></ul></div></details></div><div class=post-content><p>本文旨在深入研究如何使用Go语言优化模拟数据生成性能。我们将介绍三个不同版本的代码实现，并详细分析它们的性能和优点。</p><h2 id=版本一基础实现>版本一：基础实现<a hidden class=anchor aria-hidden=true href=#版本一基础实现>#</a></h2><p>首先，让我们来看看第一个版本的代码，这是一个基础实现，没有引入并发。以下是版本一的核心代码：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>randomVersion1</span><span class=p>(</span><span class=nx>labels</span> <span class=p>[]</span><span class=kt>int</span><span class=p>)</span> <span class=o>*</span><span class=nx>strings</span><span class=p>.</span><span class=nx>Builder</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>str</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>strings</span><span class=p>.</span><span class=nx>Builder</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=nx>labels</span><span class=p>);</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>switch</span> <span class=nx>labels</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nx>str</span><span class=p>.</span><span class=nf>WriteString</span><span class=p>(</span><span class=nx>strconv</span><span class=p>.</span><span class=nf>Itoa</span><span class=p>(</span><span class=nx>rand</span><span class=p>.</span><span class=nf>Intn</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nx>str</span><span class=p>.</span><span class=nf>WriteString</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%.8f&#34;</span><span class=p>,</span> <span class=mf>0.1</span><span class=o>+</span><span class=nx>rand</span><span class=p>.</span><span class=nf>Float64</span><span class=p>()</span><span class=o>*</span><span class=p>(</span><span class=mi>1</span><span class=o>-</span><span class=mf>0.1</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=nx>labels</span><span class=p>)</span><span class=o>-</span><span class=mi>1</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>str</span><span class=p>.</span><span class=nf>WriteString</span><span class=p>(</span><span class=s>&#34;,&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>str</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>TestVersion1</span><span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>testing</span><span class=p>.</span><span class=nx>T</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>f</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>OpenFile</span><span class=p>(</span><span class=nx>filename</span><span class=p>,</span> <span class=nx>os</span><span class=p>.</span><span class=nx>O_CREATE</span><span class=p>|</span><span class=nx>os</span><span class=p>.</span><span class=nx>O_RDWR</span><span class=p>|</span><span class=nx>os</span><span class=p>.</span><span class=nx>O_TRUNC</span><span class=p>,</span> <span class=mo>0644</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>buf</span> <span class=o>:=</span> <span class=nx>bufio</span><span class=p>.</span><span class=nf>NewWriter</span><span class=p>(</span><span class=nx>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>s</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>buf</span><span class=p>.</span><span class=nf>WriteString</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%s\n&#34;</span><span class=p>,</span> <span class=nx>header</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=mi>1000000</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>buf</span><span class=p>.</span><span class=nf>WriteString</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%d,%s\n&#34;</span><span class=p>,</span> <span class=nx>i</span><span class=p>,</span> <span class=nf>randomVersion1</span><span class=p>(</span><span class=nx>labels</span><span class=p>).</span><span class=nf>String</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;version1 use time: &#34;</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Since</span><span class=p>(</span><span class=nx>s</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=版本一的特点>版本一的特点：<a hidden class=anchor aria-hidden=true href=#版本一的特点>#</a></h3><ul><li>使用 <code>strings.Builder</code> 和 <code>bufio.Writer</code> 进行字符串和文件操作，以提高性能。</li><li>利用 <code>os.OpenFile</code> 和 <code>bufio.NewWriter</code> 来进行文件操作，确保高效且安全。</li></ul><h2 id=版本二引入并发>版本二：引入并发<a hidden class=anchor aria-hidden=true href=#版本二引入并发>#</a></h2><p>接下来，我们将介绍版本二的代码，它引入了并发处理，通过协程和通道来提高性能。以下是版本二的核心代码示例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>randomVersion2</span><span class=p>(</span><span class=nx>labels</span> <span class=p>[]</span><span class=kt>int</span><span class=p>,</span> <span class=nx>columnCh</span> <span class=kd>chan</span> <span class=o>*</span><span class=nx>strings</span><span class=p>.</span><span class=nx>Builder</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>str</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>strings</span><span class=p>.</span><span class=nx>Builder</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=nx>labels</span><span class=p>);</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>switch</span> <span class=nx>labels</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=nx>str</span><span class=p>.</span><span class=nf>WriteString</span><span class=p>(</span><span class=nx>strconv</span><span class=p>.</span><span class=nf>Itoa</span><span class=p>(</span><span class=nx>rand</span><span class=p>.</span><span class=nf>Intn</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=nx>str</span><span class=p>.</span><span class=nf>WriteString</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%.8f&#34;</span><span class=p>,</span> <span class=mf>0.1</span><span class=o>+</span><span class=nx>rand</span><span class=p>.</span><span class=nf>Float64</span><span class=p>()</span><span class=o>*</span><span class=p>(</span><span class=mi>1</span><span class=o>-</span><span class=mf>0.1</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=nx>labels</span><span class=p>)</span><span class=o>-</span><span class=mi>1</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>str</span><span class=p>.</span><span class=nf>WriteString</span><span class=p>(</span><span class=s>&#34;,&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>columnCh</span> <span class=o>&lt;-</span> <span class=nx>str</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>TestVersion2</span><span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>testing</span><span class=p>.</span><span class=nx>T</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>f</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>OpenFile</span><span class=p>(</span><span class=nx>filename</span><span class=p>,</span> <span class=nx>os</span><span class=p>.</span><span class=nx>O_CREATE</span><span class=p>|</span><span class=nx>os</span><span class=p>.</span><span class=nx>O_RDWR</span><span class=p>|</span><span class=nx>os</span><span class=p>.</span><span class=nx>O_TRUNC</span><span class=p>,</span> <span class=mo>0644</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>buf</span> <span class=o>:=</span> <span class=nx>bufio</span><span class=p>.</span><span class=nf>NewWriter</span><span class=p>(</span><span class=nx>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>s</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>buf</span><span class=p>.</span><span class=nf>WriteString</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%s\n&#34;</span><span class=p>,</span> <span class=nx>header</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>columCh</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=o>*</span><span class=nx>strings</span><span class=p>.</span><span class=nx>Builder</span><span class=p>,</span> <span class=mi>2000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>countCh</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>int</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>wg</span> <span class=o>:=</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>WaitGroup</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>worker</span> <span class=o>:=</span> <span class=kd>func</span><span class=p>(</span><span class=nx>n</span> <span class=kd>chan</span> <span class=kt>int</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>_</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>n</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>wg</span><span class=p>.</span><span class=nf>Done</span><span class=p>()</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nf>randomVersion2</span><span class=p>(</span><span class=nx>labels</span><span class=p>,</span> <span class=nx>columCh</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nx>runtime</span><span class=p>.</span><span class=nf>NumCPU</span><span class=p>()</span><span class=o>*</span><span class=mi>2</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>wg</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>go</span> <span class=nf>worker</span><span class=p>(</span><span class=nx>countCh</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=mi>1000000</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>countCh</span> <span class=o>&lt;-</span> <span class=nx>i</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nb>close</span><span class=p>(</span><span class=nx>countCh</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=mi>1000000</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>colum</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>columCh</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>buf</span><span class=p>.</span><span class=nf>WriteString</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%d,%s\n&#34;</span><span class=p>,</span> <span class=nx>i</span><span class=p>,</span> <span class=nx>colum</span><span class=p>.</span><span class=nf>String</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;version2 use time: &#34;</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Since</span><span class=p>(</span><span class=nx>s</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=版本二的优势>版本二的优势<a hidden class=anchor aria-hidden=true href=#版本二的优势>#</a></h3><ul><li><strong>卓越的性能</strong>：通过并发，版本二在多核 CPU 上表现出色。</li><li><strong>最大程度地利用系统资源</strong>：根据CPU核心数创建工作线程，更有效地管理资源。</li><li><strong>优越的扩展性</strong>：使用工作队列和协程模型，易于扩展。</li><li><strong>精确的任务管理</strong>：结合 <code>sync.WaitGroup</code> 和通道，确保任务的准确执行。</li><li><strong>增强的吞吐量</strong>：通过使用缓冲通道，提高性能。</li></ul><h2 id=版本三进一步优化>版本三：进一步优化<a hidden class=anchor aria-hidden=true href=#版本三进一步优化>#</a></h2><p>版本三对性能和内存效率进行了更深层次的优化，引入了自定义随机源和对象池。以下是版本三的核心代码示例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>randSource</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>rand</span><span class=p>.</span><span class=nx>Source</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>randSource</span><span class=p>)</span> <span class=nf>Float64</span><span class=p>()</span> <span class=kt>float64</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Change from Go 1 -- make results be uniform.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>return</span> <span class=p>(</span><span class=nb>float64</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nf>Int63</span><span class=p>()</span> <span class=o>&gt;&gt;</span> <span class=mi>10</span><span class=p>))</span> <span class=o>*</span> <span class=p>(</span><span class=mf>1.0</span> <span class=o>/</span> <span class=mf>9007199254740992.0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>randSource</span><span class=p>)</span> <span class=nf>Int</span><span class=p>()</span> <span class=kt>int64</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Change from Go 1 -- make results be uniform.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>return</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Int63</span><span class=p>()</span> <span class=o>%</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>randomVersion2</span><span class=p>(</span><span class=nx>labels</span> <span class=p>[]</span><span class=kt>int</span><span class=p>,</span> <span class=nx>columnCh</span> <span class=kd>chan</span> <span class=o>*</span><span class=nx>strings</span><span class=p>.</span><span class=nx>Builder</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>str</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>strings</span><span class=p>.</span><span class=nx>Builder</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=nx>labels</span><span class=p>);</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>switch</span> <span class=nx>labels</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=nx>str</span><span class=p>.</span><span class=nf>WriteString</span><span class=p>(</span><span class=nx>strconv</span><span class=p>.</span><span class=nf>Itoa</span><span class=p>(</span><span class=nx>rand</span><span class=p>.</span><span class=nf>Intn</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=nx>str</span><span class=p>.</span><span class=nf>WriteString</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%.8f&#34;</span><span class=p>,</span> <span class=mf>0.1</span><span class=o>+</span><span class=nx>rand</span><span class=p>.</span><span class=nf>Float64</span><span class=p>()</span><span class=o>*</span><span class=p>(</span><span class=mi>1</span><span class=o>-</span><span class=mf>0.1</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=nx>labels</span><span class=p>)</span><span class=o>-</span><span class=mi>1</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>str</span><span class=p>.</span><span class=nf>WriteString</span><span class=p>(</span><span class=s>&#34;,&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>columnCh</span> <span class=o>&lt;-</span> <span class=nx>str</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>TestVersion3</span><span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>testing</span><span class=p>.</span><span class=nx>T</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>poolBuilder</span> <span class=o>:=</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>Pool</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>New</span><span class=p>:</span> <span class=kd>func</span><span class=p>()</span> <span class=kd>interface</span><span class=p>{}</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>bytes</span><span class=p>.</span><span class=nf>NewBuffer</span><span class=p>(</span><span class=nb>make</span><span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>4096</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>poolBuf</span> <span class=o>:=</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>Pool</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>New</span><span class=p>:</span> <span class=kd>func</span><span class=p>()</span> <span class=kd>interface</span><span class=p>{}</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>wg</span> <span class=o>:=</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>WaitGroup</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=nx>count</span> <span class=o>:=</span> <span class=mi>1000000</span>
</span></span><span class=line><span class=cl>	<span class=nx>countCh</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>int</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>columCh</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=o>*</span><span class=nx>bytes</span><span class=p>.</span><span class=nx>Buffer</span><span class=p>,</span> <span class=mi>2000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>random</span> <span class=o>:=</span> <span class=kd>func</span><span class=p>(</span><span class=nx>labels</span> <span class=p>[]</span><span class=kt>int</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>randSource</span><span class=p>,</span> <span class=nx>columCh</span> <span class=kd>chan</span> <span class=o>*</span><span class=nx>bytes</span><span class=p>.</span><span class=nx>Buffer</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>str</span> <span class=o>:=</span> <span class=nx>poolBuilder</span><span class=p>.</span><span class=nf>Get</span><span class=p>().(</span><span class=o>*</span><span class=nx>bytes</span><span class=p>.</span><span class=nx>Buffer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>buf</span> <span class=o>:=</span> <span class=nx>poolBuf</span><span class=p>.</span><span class=nf>Get</span><span class=p>().([]</span><span class=kt>byte</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=nx>labels</span><span class=p>);</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>switch</span> <span class=nx>labels</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>case</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>				<span class=nx>str</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=nx>strconv</span><span class=p>.</span><span class=nf>AppendInt</span><span class=p>(</span><span class=nx>buf</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Int</span><span class=p>(),</span> <span class=mi>10</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=k>case</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>				<span class=nx>str</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=nx>strconv</span><span class=p>.</span><span class=nf>AppendFloat</span><span class=p>(</span><span class=nx>buf</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Float64</span><span class=p>(),</span> <span class=sc>&#39;f&#39;</span><span class=p>,</span> <span class=mi>8</span><span class=p>,</span> <span class=mi>64</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=nx>labels</span><span class=p>)</span><span class=o>-</span><span class=mi>1</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>str</span><span class=p>.</span><span class=nf>WriteByte</span><span class=p>(</span><span class=sc>&#39;,&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>poolBuf</span><span class=p>.</span><span class=nf>Put</span><span class=p>(</span><span class=nx>buf</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>columCh</span> <span class=o>&lt;-</span> <span class=nx>str</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>f</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>OpenFile</span><span class=p>(</span><span class=nx>filename</span><span class=p>,</span> <span class=nx>os</span><span class=p>.</span><span class=nx>O_CREATE</span><span class=p>|</span><span class=nx>os</span><span class=p>.</span><span class=nx>O_RDWR</span><span class=p>|</span><span class=nx>os</span><span class=p>.</span><span class=nx>O_TRUNC</span><span class=p>,</span> <span class=mo>0644</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>buf</span> <span class=o>:=</span> <span class=nx>bufio</span><span class=p>.</span><span class=nf>NewWriter</span><span class=p>(</span><span class=nx>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>s</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>buf</span><span class=p>.</span><span class=nf>WriteString</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%s\n&#34;</span><span class=p>,</span> <span class=nx>header</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>worker</span> <span class=o>:=</span> <span class=kd>func</span><span class=p>(</span><span class=nx>n</span> <span class=kd>chan</span> <span class=kt>int</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>r</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>randSource</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>Source</span><span class=p>:</span> <span class=nx>rand</span><span class=p>.</span><span class=nf>NewSource</span><span class=p>(</span><span class=nx>rand</span><span class=p>.</span><span class=nf>Int63</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>_</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>n</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>wg</span><span class=p>.</span><span class=nf>Done</span><span class=p>()</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nf>random</span><span class=p>(</span><span class=nx>labels</span><span class=p>,</span> <span class=nx>r</span><span class=p>,</span> <span class=nx>columCh</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nx>runtime</span><span class=p>.</span><span class=nf>NumCPU</span><span class=p>()</span><span class=o>*</span><span class=mi>2</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>wg</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>go</span> <span class=nf>worker</span><span class=p>(</span><span class=nx>countCh</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nx>runtime</span><span class=p>.</span><span class=nf>NumCPU</span><span class=p>()</span><span class=o>*</span><span class=mi>2</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>wg</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>go</span> <span class=nf>worker</span><span class=p>(</span><span class=nx>countCh</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nx>count</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>countCh</span> <span class=o>&lt;-</span> <span class=nx>i</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nb>close</span><span class=p>(</span><span class=nx>countCh</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nx>count</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>colum</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>columCh</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>b</span> <span class=o>:=</span> <span class=nx>poolBuf</span><span class=p>.</span><span class=nf>Get</span><span class=p>().([]</span><span class=kt>byte</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>buf</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=nx>strconv</span><span class=p>.</span><span class=nf>AppendInt</span><span class=p>(</span><span class=nx>b</span><span class=p>,</span> <span class=nb>int64</span><span class=p>(</span><span class=nx>i</span><span class=p>),</span> <span class=mi>10</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=nx>buf</span><span class=p>.</span><span class=nf>WriteByte</span><span class=p>(</span><span class=sc>&#39;,&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>buf</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=nx>colum</span><span class=p>.</span><span class=nf>Bytes</span><span class=p>())</span>
</span></span><span class=line><span class=cl>		<span class=nx>buf</span><span class=p>.</span><span class=nf>WriteByte</span><span class=p>(</span><span class=sc>&#39;\n&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>colum</span><span class=p>.</span><span class=nf>Reset</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=nx>poolBuilder</span><span class=p>.</span><span class=nf>Put</span><span class=p>(</span><span class=nx>colum</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>poolBuf</span><span class=p>.</span><span class=nf>Put</span><span class=p>(</span><span class=nx>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>buf</span><span class=p>.</span><span class=nf>Flush</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>f</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;version3 use time:&#34;</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Since</span><span class=p>(</span><span class=nx>s</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=go代码testversion3-函数与-randomversion2-函数的区别和优势>Go代码：<code>TestVersion3</code> 函数与 <code>randomVersion2</code> 函数的区别和优势<a hidden class=anchor aria-hidden=true href=#go代码testversion3-函数与-randomversion2-函数的区别和优势>#</a></h4><ul><li><strong>减少内存占用</strong>：使用 sync.Pool 重用内存，有效降低GC负担。</li><li><strong>改进性能</strong>：借助字节操作和缓冲，提高性能。</li><li><strong>更高的并发性</strong>：通过增加工作线程数量，充分发挥多核CPU的威力。</li><li><strong>更精确的随机数生成</strong>：自定义随机数源生成更均匀的随机数，无需竞争全局锁。</li><li><strong>优化的代码结构</strong>：将随机数生成逻辑封装在函数中，提高代码的可维护性和可重用性。</li><li><strong>更快的数据写入</strong>：借助字节操作和缓冲，提高数据写入速度。</li><li><strong>全局锁的区别</strong>：在版本三中，我们引入了自定义的 randSource 结构，并重写了 Float64 和 Int 方法，以自定义随机数生成的方式。通过这种方式，我们无需竞争 rand 包的全局锁，从而避免了在多线程环境下可能出现的性能瓶颈。</li></ul><p>通过这些改进，<code>TestVersion3</code>在性能、内存效率和可扩展性方面都有明显的优势。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://mioto.me/tags/go/>Go</a></li></ul></footer><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//yakumioto.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></main><footer class=footer><span>&copy; 2024 <a href=https://mioto.me>一只麻酱</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>