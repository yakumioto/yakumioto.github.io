<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Hyperledger Fabric peer block 的交付流程详解 | Mioto's Blog</title><meta name=keywords content="Go,Hyperledger Fabric"><meta name=description content="本文基于 hyperldeger fabric 1.4.7 进行代码追踪讲解
假设场景描述:
peer 重启场景 peer 有 user channel peer 使用的是 goleveldb peer 的 core.peer.gossip.orgLeader 为 true 流程简介 初始化账本根据账本中保存的 channel id 创建通道实例, 并初始化与之对等的 gossip 服务, 用 来接收对应通道的最新的 配置或交易 block, 接收到 block 后, 经过 Verify, Validate, Validate RW sets 三个验证步骤, 提交给 Ledger Commiter 进行写入文件, 并将当前通道的 blkMgrInfo 更新到最新状态
源码追踪 伊始: main -> node.Cmd -> startCmd -> nodeStartCmd -> serve
peer.Initialize 文件: core/peer/peer.go:241
初始化 ledgermgmt, 里面做的事情太多了, 要讲清楚有点困难建议大家自己去看看, 里面主要做的就是 各种初始化工作
// /var/hyperledger/production/ledgersData 下有这些东西, 这里面的工作跟此目录有关 // chains/index goleveldb: 保存了所有通道的最新状态信息 // fileLock goleveldb: 用于锁程序的,文章最末尾有介绍 // historyLeveldb goleveldb: 保存历史交易的 // ledgerProvider goleveldb: 保存的是 chain ids, 也就是通道id // pvtdataStore goleveldb: 存储私有数据库 // stateLeveldb goleveldb: 世界状态数据库, 可以替换为 couchdb // 这两个我不确定没有细追 // configHistory 看名字应该是保存了 config block 相关的东西."><meta name=author content="Mioto Yaku"><link rel=canonical href=https://mioto.me/2020/06/fab-peer-deliver-block/><link crossorigin=anonymous href=/assets/css/stylesheet.6a98292fb8fa8cf0f3ba4042d4b75515c04267550f3ad49ff6271b5af9562443.css integrity="sha256-apgpL7j6jPDzukBC1LdVFcBCZ1UPOtSf9icbWvlWJEM=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://mioto.me/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://mioto.me/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://mioto.me/favicon-32x32.png><link rel=apple-touch-icon href=https://mioto.me/apple-touch-icon.png><link rel=mask-icon href=https://mioto.me/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-102233768-1","auto"),ga("send","pageview"))</script><meta property="og:title" content="Hyperledger Fabric peer block 的交付流程详解"><meta property="og:description" content="本文基于 hyperldeger fabric 1.4.7 进行代码追踪讲解
假设场景描述:
peer 重启场景 peer 有 user channel peer 使用的是 goleveldb peer 的 core.peer.gossip.orgLeader 为 true 流程简介 初始化账本根据账本中保存的 channel id 创建通道实例, 并初始化与之对等的 gossip 服务, 用 来接收对应通道的最新的 配置或交易 block, 接收到 block 后, 经过 Verify, Validate, Validate RW sets 三个验证步骤, 提交给 Ledger Commiter 进行写入文件, 并将当前通道的 blkMgrInfo 更新到最新状态
源码追踪 伊始: main -> node.Cmd -> startCmd -> nodeStartCmd -> serve
peer.Initialize 文件: core/peer/peer.go:241
初始化 ledgermgmt, 里面做的事情太多了, 要讲清楚有点困难建议大家自己去看看, 里面主要做的就是 各种初始化工作
// /var/hyperledger/production/ledgersData 下有这些东西, 这里面的工作跟此目录有关 // chains/index goleveldb: 保存了所有通道的最新状态信息 // fileLock goleveldb: 用于锁程序的,文章最末尾有介绍 // historyLeveldb goleveldb: 保存历史交易的 // ledgerProvider goleveldb: 保存的是 chain ids, 也就是通道id // pvtdataStore goleveldb: 存储私有数据库 // stateLeveldb goleveldb: 世界状态数据库, 可以替换为 couchdb // 这两个我不确定没有细追 // configHistory 看名字应该是保存了 config block 相关的东西."><meta property="og:type" content="article"><meta property="og:url" content="https://mioto.me/2020/06/fab-peer-deliver-block/"><meta property="article:section" content="post"><meta property="article:published_time" content="2020-06-15T00:00:00+00:00"><meta property="article:modified_time" content="2020-06-15T00:00:00+00:00"><meta property="og:site_name" content="圁水"><meta name=twitter:card content="summary"><meta name=twitter:title content="Hyperledger Fabric peer block 的交付流程详解"><meta name=twitter:description content="本文基于 hyperldeger fabric 1.4.7 进行代码追踪讲解
假设场景描述:
peer 重启场景 peer 有 user channel peer 使用的是 goleveldb peer 的 core.peer.gossip.orgLeader 为 true 流程简介 初始化账本根据账本中保存的 channel id 创建通道实例, 并初始化与之对等的 gossip 服务, 用 来接收对应通道的最新的 配置或交易 block, 接收到 block 后, 经过 Verify, Validate, Validate RW sets 三个验证步骤, 提交给 Ledger Commiter 进行写入文件, 并将当前通道的 blkMgrInfo 更新到最新状态
源码追踪 伊始: main -> node.Cmd -> startCmd -> nodeStartCmd -> serve
peer.Initialize 文件: core/peer/peer.go:241
初始化 ledgermgmt, 里面做的事情太多了, 要讲清楚有点困难建议大家自己去看看, 里面主要做的就是 各种初始化工作
// /var/hyperledger/production/ledgersData 下有这些东西, 这里面的工作跟此目录有关 // chains/index goleveldb: 保存了所有通道的最新状态信息 // fileLock goleveldb: 用于锁程序的,文章最末尾有介绍 // historyLeveldb goleveldb: 保存历史交易的 // ledgerProvider goleveldb: 保存的是 chain ids, 也就是通道id // pvtdataStore goleveldb: 存储私有数据库 // stateLeveldb goleveldb: 世界状态数据库, 可以替换为 couchdb // 这两个我不确定没有细追 // configHistory 看名字应该是保存了 config block 相关的东西."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://mioto.me/post/"},{"@type":"ListItem","position":3,"name":"Hyperledger Fabric peer block 的交付流程详解","item":"https://mioto.me/2020/06/fab-peer-deliver-block/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Hyperledger Fabric peer block 的交付流程详解","name":"Hyperledger Fabric peer block 的交付流程详解","description":"本文基于 hyperldeger fabric 1.4.7 进行代码追踪讲解\n假设场景描述:\npeer 重启场景 peer 有 user channel peer 使用的是 goleveldb peer 的 core.peer.gossip.orgLeader 为 true 流程简介 初始化账本根据账本中保存的 channel id 创建通道实例, 并初始化与之对等的 gossip 服务, 用 来接收对应通道的最新的 配置或交易 block, 接收到 block 后, 经过 Verify, Validate, Validate RW sets 三个验证步骤, 提交给 Ledger Commiter 进行写入文件, 并将当前通道的 blkMgrInfo 更新到最新状态\n源码追踪 伊始: main -\u0026gt; node.Cmd -\u0026gt; startCmd -\u0026gt; nodeStartCmd -\u0026gt; serve\npeer.Initialize 文件: core/peer/peer.go:241\n初始化 ledgermgmt, 里面做的事情太多了, 要讲清楚有点困难建议大家自己去看看, 里面主要做的就是 各种初始化工作\n// /var/hyperledger/production/ledgersData 下有这些东西, 这里面的工作跟此目录有关 // chains/index goleveldb: 保存了所有通道的最新状态信息 // fileLock goleveldb: 用于锁程序的,文章最末尾有介绍 // historyLeveldb goleveldb: 保存历史交易的 // ledgerProvider goleveldb: 保存的是 chain ids, 也就是通道id // pvtdataStore goleveldb: 存储私有数据库 // stateLeveldb goleveldb: 世界状态数据库, 可以替换为 couchdb // 这两个我不确定没有细追 // configHistory 看名字应该是保存了 config block 相关的东西.","keywords":["Go","Hyperledger Fabric"],"articleBody":"本文基于 hyperldeger fabric 1.4.7 进行代码追踪讲解\n假设场景描述:\npeer 重启场景 peer 有 user channel peer 使用的是 goleveldb peer 的 core.peer.gossip.orgLeader 为 true 流程简介 初始化账本根据账本中保存的 channel id 创建通道实例, 并初始化与之对等的 gossip 服务, 用 来接收对应通道的最新的 配置或交易 block, 接收到 block 后, 经过 Verify, Validate, Validate RW sets 三个验证步骤, 提交给 Ledger Commiter 进行写入文件, 并将当前通道的 blkMgrInfo 更新到最新状态\n源码追踪 伊始: main -\u003e node.Cmd -\u003e startCmd -\u003e nodeStartCmd -\u003e serve\npeer.Initialize 文件: core/peer/peer.go:241\n初始化 ledgermgmt, 里面做的事情太多了, 要讲清楚有点困难建议大家自己去看看, 里面主要做的就是 各种初始化工作\n// /var/hyperledger/production/ledgersData 下有这些东西, 这里面的工作跟此目录有关 // chains/index goleveldb: 保存了所有通道的最新状态信息 // fileLock goleveldb: 用于锁程序的,文章最末尾有介绍 // historyLeveldb goleveldb: 保存历史交易的 // ledgerProvider goleveldb: 保存的是 chain ids, 也就是通道id // pvtdataStore goleveldb: 存储私有数据库 // stateLeveldb goleveldb: 世界状态数据库, 可以替换为 couchdb // 这两个我不确定没有细追 // configHistory 看名字应该是保存了 config block 相关的东西. // bookkeeper 不知道. ledgermgmt.Initialize(\u0026ledgermgmt.Initializer{ CustomTxProcessors: ConfigTxProcessors, PlatformRegistry: pr, DeployedChaincodeInfoProvider: deployedCCInfoProvider, MembershipInfoProvider: membershipProvider, MetricsProvider: metricsProvider, }) // 就是通过 /var/hyperledger/production/ledgersData/ledgerProvider 获取的 id 列表 ledgerIds, err := ledgermgmt.GetLedgerIDs() ... for _, cid := range ledgerIds { // 打开对应通道的账本, 例如打开 block 的最新文件, 加载最新的账本信息等 if ledger, err = ledgermgmt.OpenLedger(cid); err != nil { ... } // 获取最新的交易块, 通过交易块获取最新的配置块的 number, 在通过 number 查询到最新的配置块 // 有兴趣可以往下追一追看看 if cb, err = getCurrConfigBlockFromLedger(ledger); err != nil { ... } // 创建通道实例, 传了 通道id, 账本实例, 最新的配置块等. if err = createChain(cid, ledger, cb, ccp, sccp, pm); err != nil { ... } InitChain(cid) } func createChain( cid string, ledger ledger.PeerLedger, cb *common.Block, ccp ccprovider.ChaincodeProvider, sccp sysccprovider.SystemChaincodeProvider, pm txvalidator.PluginMapper, ) error { // 初始化 gossip 服务用到的配置, vscc, 等相关资源初始化, 有兴趣的可以看看这个函数, // 这里就不做介绍了 ... // 初始化 gossip service 方法 service.GetGossipService().InitializeChannel(bundle.ConfigtxValidator().ChainID(), oac, service.Support{ Validator: validator, Committer: c, Store: store, Cs: simpleCollectionStore, IdDeserializeFactory: csStoreSupport, CapabilityProvider: cp, }) ... return nil } service.gossipServiceImpl.InitializeChannel 文件: gossip/service/gossip_service.go:273\ngossip service 的作用是管理 gossip client, 每个 channel 会启动一个 gossip client 每个 gossip client 会启动一个 deliver block\n在 InitializeChannel 主要是初始化工作的\n初始化 private data fetcher 初始化 coordinator 初始化 gossip 参数 func (g *gossipServiceImpl) InitializeChannel(chainID string, oac OrdererAddressConfig, support Support) { ... // Delivery service might be nil only if it was not able to get connected // to the ordering service if g.deliveryService[chainID] != nil { // 根据 core.yaml 或者 环境变量设置的两个个值在下方有不同的启动方式 leaderElection := viper.GetBool(\"peer.gossip.useLeaderElection\") isStaticOrgLeader := viper.GetBool(\"peer.gossip.orgLeader\") ... if leaderElection { logger.Debug(\"Delivery uses dynamic leader election mechanism, channel\", chainID) g.leaderElection[chainID] = g.newLeaderElectionComponent(chainID, g.onStatusChangeFactory(chainID, support.Committer), g.metrics.ElectionMetrics) } else if isStaticOrgLeader { logger.Debug(\"This peer is configured to connect to ordering service for blocks delivery, channel\", chainID) g.deliveryService[chainID].StartDeliverForChannel(chainID, support.Committer, func() {}) } else { logger.Debug(\"This peer is not configured to connect to ordering service for blocks delivery, channel\", chainID) } } else { logger.Warning(\"Delivery client is down won't be able to pull blocks for chain\", chainID) } } blocksprovider.blocksProviderImpl.DeliverBlocks 文件: core/deliverservice/blocksprovider/blocksprovider.go:110\n获取到最新的 gossip message, 根据类型判断是否是区块, 然后调用 VerifyBlock 进行验, 最后在添加到账本中\nfunc (b *blocksProviderImpl) DeliverBlocks() { ... for !b.isDone() { ... switch t := msg.Type.(type) { case *orderer.DeliverResponse_Status: ... case *orderer.DeliverResponse_Block: ... if err := b.mcs.VerifyBlock(gossipcommon.ChainID(b.chainID), blockNum, marshaledBlock); err != nil { logger.Errorf(\"[%s] Error verifying block with sequence number %d, due to %s\", b.chainID, blockNum, err) continue } ... if err := b.gossip.AddPayload(b.chainID, payload); err != nil { logger.Warningf(\"Block [%d] received from ordering service wasn't added to payload buffer: %v\", blockNum, err) } ... default: logger.Warningf(\"[%s] Received unknown: %v\", b.chainID, t) return } } } state.GossipStateProviderImpl.commitBlock 文件: gossip/state/state.go:805\nblock 经过一层层的传递, 最终到了 gossip state 中, 这也是 block 在 gossip 中的最后一环\nfunc (s *GossipStateProviderImpl) commitBlock(block *common.Block, pvtData util.PvtDataCollections) error { ... // 将 block 和 pvtdata 交给 ledger 进行存储 if err := s.ledger.StoreBlock(block, pvtData); err != nil { logger.Errorf(\"Got error while committing(%+v)\", errors.WithStack(err)) return err } ... } privdata.coordinator.StoreBlock 文件: gossip/privdata/coordinator.go:163\n在这里面会校验 block 的签名, 读写集等, 然后传给 CommitWithPvtData 方法\nfunc (c *coordinator) StoreBlock(block *common.Block, privateDataSets util.PvtDataCollections) error { ... validationStart := time.Now() err := c.Validator.Validate(block) c.reportValidationDuration(time.Since(validationStart)) if err != nil { logger.Errorf(\"Validation failed: %+v\", err) return err } ... // commit block and private data commitStart := time.Now() err = c.CommitWithPvtData(blockAndPvtData, \u0026ledger.CommitOptions{}) c.reportCommitDuration(time.Since(commitStart)) if err != nil { return errors.Wrap(err, \"commit failed\") } ... return nil } committer.LedgerCommitter.CommitWithPvtData 文件: core/committer/committer_impl.go:87\n块会交给 kvledger 进行存储, 以下追踪就跟主题无关了, 我把方法列到下面, 有需求可以自己看\nkvledger.kvLedger.CommitWithPvtData: core/ledger/ledgerstorage/store.go:113\nfsblkstorage.fsBlockStore.AddBlock: common/ledger/blkstorage/fsblkstorage/fs_blockstore.go:51\nfsblkstorage.blockfileMgr.addBlock: common/ledger/blkstorage/fsblkstorage/blockfile_mgr.go:240\n额外收获 fileLock Fabric 中的 ledger management 有一个数据库叫做 fileLock, 最开始不理解为什么要这 么实现,后来读这部分 UnLock 的代码发现, 这是类似于一个君子协议的东西, peer reset 命令里 会打开该数据库, 如果失败就证明有其他程序在使用.\n栗子:\npeer node start 启动时会打开 fileLock 的数据库连接, 这时如果你想执行peer reset 这个进程启动是也会去对 fileLock 创建连接, 但是会失败, peer reset 会终止.\n参考 https://github.com/hyperledger/fabric/tree/v1.4.7\n","wordCount":"676","inLanguage":"zh","datePublished":"2020-06-15T00:00:00Z","dateModified":"2020-06-15T00:00:00Z","author":{"@type":"Person","name":"Mioto Yaku"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://mioto.me/2020/06/fab-peer-deliver-block/"},"publisher":{"@type":"Organization","name":"Mioto's Blog","logo":{"@type":"ImageObject","url":"https://mioto.me/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://mioto.me accesskey=h title="Mioto's Blog (Alt + H)">Mioto's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://mioto.me/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://mioto.me/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Hyperledger Fabric peer block 的交付流程详解</h1><div class=post-meta><span title='2020-06-15 00:00:00 +0000 UTC'>六月 15, 2020</span>&nbsp;·&nbsp;Mioto Yaku</div></header><div class=post-content><p>本文基于 <code>hyperldeger fabric 1.4.7</code> 进行代码追踪讲解</p><p>假设场景描述:</p><ol><li>peer 重启场景</li><li>peer 有 user channel</li><li>peer 使用的是 goleveldb</li><li>peer 的 <code>core.peer.gossip.orgLeader</code> 为 <code>true</code></li></ol><h2 id=流程简介>流程简介<a hidden class=anchor aria-hidden=true href=#流程简介>#</a></h2><p>初始化账本根据账本中保存的 <code>channel id</code> 创建通道实例, 并初始化与之对等的 <code>gossip</code> 服务, 用
来接收对应通道的最新的 配置或交易 <code>block</code>, 接收到 <code>block</code> 后, 经过 <code>Verify</code>, <code>Validate</code>,
<code>Validate RW sets</code> 三个验证步骤, 提交给 <code>Ledger Commiter</code> 进行写入文件, 并将当前通道的
<code>blkMgrInfo</code> 更新到最新状态</p><h2 id=源码追踪>源码追踪<a hidden class=anchor aria-hidden=true href=#源码追踪>#</a></h2><p>伊始: main -> node.Cmd -> startCmd -> nodeStartCmd -> serve</p><h3 id=peerinitialize>peer.Initialize<a hidden class=anchor aria-hidden=true href=#peerinitialize>#</a></h3><p>文件: <code>core/peer/peer.go:241</code></p><p>初始化 ledgermgmt, 里面做的事情太多了, 要讲清楚有点困难建议大家自己去看看, 里面主要做的就是
各种初始化工作</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// /var/hyperledger/production/ledgersData 下有这些东西, 这里面的工作跟此目录有关
</span></span></span><span class=line><span class=cl><span class=c1>// chains/index goleveldb: 保存了所有通道的最新状态信息
</span></span></span><span class=line><span class=cl><span class=c1>// fileLock goleveldb: 用于锁程序的,文章最末尾有介绍
</span></span></span><span class=line><span class=cl><span class=c1>// historyLeveldb goleveldb: 保存历史交易的
</span></span></span><span class=line><span class=cl><span class=c1>// ledgerProvider goleveldb: 保存的是 chain ids, 也就是通道id
</span></span></span><span class=line><span class=cl><span class=c1>// pvtdataStore goleveldb: 存储私有数据库
</span></span></span><span class=line><span class=cl><span class=c1>// stateLeveldb goleveldb: 世界状态数据库, 可以替换为 couchdb
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 这两个我不确定没有细追
</span></span></span><span class=line><span class=cl><span class=c1>// configHistory 看名字应该是保存了 config block 相关的东西.
</span></span></span><span class=line><span class=cl><span class=c1>// bookkeeper 不知道.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>ledgermgmt</span><span class=p>.</span><span class=nf>Initialize</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>ledgermgmt</span><span class=p>.</span><span class=nx>Initializer</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>CustomTxProcessors</span><span class=p>:</span>            <span class=nx>ConfigTxProcessors</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>PlatformRegistry</span><span class=p>:</span>              <span class=nx>pr</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>DeployedChaincodeInfoProvider</span><span class=p>:</span> <span class=nx>deployedCCInfoProvider</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>MembershipInfoProvider</span><span class=p>:</span>        <span class=nx>membershipProvider</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>MetricsProvider</span><span class=p>:</span>               <span class=nx>metricsProvider</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 就是通过 /var/hyperledger/production/ledgersData/ledgerProvider 获取的 id 列表
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>ledgerIds</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ledgermgmt</span><span class=p>.</span><span class=nf>GetLedgerIDs</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>cid</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>ledgerIds</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 打开对应通道的账本, 例如打开 block 的最新文件, 加载最新的账本信息等
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>ledger</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>ledgermgmt</span><span class=p>.</span><span class=nf>OpenLedger</span><span class=p>(</span><span class=nx>cid</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 获取最新的交易块, 通过交易块获取最新的配置块的 number, 在通过 number 查询到最新的配置块
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 有兴趣可以往下追一追看看
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>cb</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nf>getCurrConfigBlockFromLedger</span><span class=p>(</span><span class=nx>ledger</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 创建通道实例, 传了 通道id, 账本实例, 最新的配置块等.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>err</span> <span class=p>=</span> <span class=nf>createChain</span><span class=p>(</span><span class=nx>cid</span><span class=p>,</span> <span class=nx>ledger</span><span class=p>,</span> <span class=nx>cb</span><span class=p>,</span> <span class=nx>ccp</span><span class=p>,</span> <span class=nx>sccp</span><span class=p>,</span> <span class=nx>pm</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>InitChain</span><span class=p>(</span><span class=nx>cid</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>createChain</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>cid</span> <span class=kt>string</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>ledger</span> <span class=nx>ledger</span><span class=p>.</span><span class=nx>PeerLedger</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>cb</span> <span class=o>*</span><span class=nx>common</span><span class=p>.</span><span class=nx>Block</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>ccp</span> <span class=nx>ccprovider</span><span class=p>.</span><span class=nx>ChaincodeProvider</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>sccp</span> <span class=nx>sysccprovider</span><span class=p>.</span><span class=nx>SystemChaincodeProvider</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>pm</span> <span class=nx>txvalidator</span><span class=p>.</span><span class=nx>PluginMapper</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 初始化 gossip 服务用到的配置, vscc, 等相关资源初始化, 有兴趣的可以看看这个函数,
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 这里就不做介绍了
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 初始化 gossip service 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>service</span><span class=p>.</span><span class=nf>GetGossipService</span><span class=p>().</span><span class=nf>InitializeChannel</span><span class=p>(</span><span class=nx>bundle</span><span class=p>.</span><span class=nf>ConfigtxValidator</span><span class=p>().</span><span class=nf>ChainID</span><span class=p>(),</span> <span class=nx>oac</span><span class=p>,</span> <span class=nx>service</span><span class=p>.</span><span class=nx>Support</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>Validator</span><span class=p>:</span>            <span class=nx>validator</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>Committer</span><span class=p>:</span>            <span class=nx>c</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>Store</span><span class=p>:</span>                <span class=nx>store</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>Cs</span><span class=p>:</span>                   <span class=nx>simpleCollectionStore</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>IdDeserializeFactory</span><span class=p>:</span> <span class=nx>csStoreSupport</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>CapabilityProvider</span><span class=p>:</span>   <span class=nx>cp</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=servicegossipserviceimplinitializechannel>service.gossipServiceImpl.InitializeChannel<a hidden class=anchor aria-hidden=true href=#servicegossipserviceimplinitializechannel>#</a></h3><p>文件: <code>gossip/service/gossip_service.go:273</code></p><p><code>gossip service</code> 的作用是管理 <code>gossip client</code>, 每个 <code>channel</code> 会启动一个 <code>gossip client</code>
每个 <code>gossip client</code> 会启动一个 <code>deliver block</code></p><p>在 <code>InitializeChannel</code> 主要是初始化工作的</p><ol><li>初始化 <code>private data fetcher</code></li><li>初始化 <code>coordinator</code></li><li>初始化 <code>gossip</code> 参数</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>g</span> <span class=o>*</span><span class=nx>gossipServiceImpl</span><span class=p>)</span> <span class=nf>InitializeChannel</span><span class=p>(</span><span class=nx>chainID</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>oac</span> <span class=nx>OrdererAddressConfig</span><span class=p>,</span> <span class=nx>support</span> <span class=nx>Support</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Delivery service might be nil only if it was not able to get connected
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// to the ordering service
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>g</span><span class=p>.</span><span class=nx>deliveryService</span><span class=p>[</span><span class=nx>chainID</span><span class=p>]</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 根据 core.yaml 或者 环境变量设置的两个个值在下方有不同的启动方式
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>leaderElection</span> <span class=o>:=</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>GetBool</span><span class=p>(</span><span class=s>&#34;peer.gossip.useLeaderElection&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>isStaticOrgLeader</span> <span class=o>:=</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>GetBool</span><span class=p>(</span><span class=s>&#34;peer.gossip.orgLeader&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>leaderElection</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>logger</span><span class=p>.</span><span class=nf>Debug</span><span class=p>(</span><span class=s>&#34;Delivery uses dynamic leader election mechanism, channel&#34;</span><span class=p>,</span> <span class=nx>chainID</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nx>g</span><span class=p>.</span><span class=nx>leaderElection</span><span class=p>[</span><span class=nx>chainID</span><span class=p>]</span> <span class=p>=</span> <span class=nx>g</span><span class=p>.</span><span class=nf>newLeaderElectionComponent</span><span class=p>(</span><span class=nx>chainID</span><span class=p>,</span> <span class=nx>g</span><span class=p>.</span><span class=nf>onStatusChangeFactory</span><span class=p>(</span><span class=nx>chainID</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>support</span><span class=p>.</span><span class=nx>Committer</span><span class=p>),</span> <span class=nx>g</span><span class=p>.</span><span class=nx>metrics</span><span class=p>.</span><span class=nx>ElectionMetrics</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>isStaticOrgLeader</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>logger</span><span class=p>.</span><span class=nf>Debug</span><span class=p>(</span><span class=s>&#34;This peer is configured to connect to ordering service for blocks delivery, channel&#34;</span><span class=p>,</span> <span class=nx>chainID</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nx>g</span><span class=p>.</span><span class=nx>deliveryService</span><span class=p>[</span><span class=nx>chainID</span><span class=p>].</span><span class=nf>StartDeliverForChannel</span><span class=p>(</span><span class=nx>chainID</span><span class=p>,</span> <span class=nx>support</span><span class=p>.</span><span class=nx>Committer</span><span class=p>,</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{})</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>logger</span><span class=p>.</span><span class=nf>Debug</span><span class=p>(</span><span class=s>&#34;This peer is not configured to connect to ordering service for blocks delivery, channel&#34;</span><span class=p>,</span> <span class=nx>chainID</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>logger</span><span class=p>.</span><span class=nf>Warning</span><span class=p>(</span><span class=s>&#34;Delivery client is down won&#39;t be able to pull blocks for chain&#34;</span><span class=p>,</span> <span class=nx>chainID</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=blocksproviderblocksproviderimpldeliverblocks>blocksprovider.blocksProviderImpl.DeliverBlocks<a hidden class=anchor aria-hidden=true href=#blocksproviderblocksproviderimpldeliverblocks>#</a></h3><p>文件: <code>core/deliverservice/blocksprovider/blocksprovider.go:110</code></p><p>获取到最新的 <code>gossip message</code>, 根据类型判断是否是区块, 然后调用 <code>VerifyBlock</code> 进行验, 最后在添加到账本中</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>b</span> <span class=o>*</span><span class=nx>blocksProviderImpl</span><span class=p>)</span> <span class=nf>DeliverBlocks</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>!</span><span class=nx>b</span><span class=p>.</span><span class=nf>isDone</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=k>switch</span> <span class=nx>t</span> <span class=o>:=</span> <span class=nx>msg</span><span class=p>.</span><span class=nx>Type</span><span class=p>.(</span><span class=kd>type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=o>*</span><span class=nx>orderer</span><span class=p>.</span><span class=nx>DeliverResponse_Status</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=o>*</span><span class=nx>orderer</span><span class=p>.</span><span class=nx>DeliverResponse_Block</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>b</span><span class=p>.</span><span class=nx>mcs</span><span class=p>.</span><span class=nf>VerifyBlock</span><span class=p>(</span><span class=nx>gossipcommon</span><span class=p>.</span><span class=nf>ChainID</span><span class=p>(</span><span class=nx>b</span><span class=p>.</span><span class=nx>chainID</span><span class=p>),</span> <span class=nx>blockNum</span><span class=p>,</span> <span class=nx>marshaledBlock</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>logger</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;[%s] Error verifying block with sequence number %d, due to %s&#34;</span><span class=p>,</span> <span class=nx>b</span><span class=p>.</span><span class=nx>chainID</span><span class=p>,</span> <span class=nx>blockNum</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>b</span><span class=p>.</span><span class=nx>gossip</span><span class=p>.</span><span class=nf>AddPayload</span><span class=p>(</span><span class=nx>b</span><span class=p>.</span><span class=nx>chainID</span><span class=p>,</span> <span class=nx>payload</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>logger</span><span class=p>.</span><span class=nf>Warningf</span><span class=p>(</span><span class=s>&#34;Block [%d] received from ordering service wasn&#39;t added to payload buffer: %v&#34;</span><span class=p>,</span> <span class=nx>blockNum</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nx>logger</span><span class=p>.</span><span class=nf>Warningf</span><span class=p>(</span><span class=s>&#34;[%s] Received unknown: %v&#34;</span><span class=p>,</span> <span class=nx>b</span><span class=p>.</span><span class=nx>chainID</span><span class=p>,</span> <span class=nx>t</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=stategossipstateproviderimplcommitblock>state.GossipStateProviderImpl.commitBlock<a hidden class=anchor aria-hidden=true href=#stategossipstateproviderimplcommitblock>#</a></h3><p>文件: <code>gossip/state/state.go:805</code></p><p><code>block</code> 经过一层层的传递, 最终到了 <code>gossip state</code> 中, 这也是 <code>block</code> 在 <code>gossip</code> 中的最后一环</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>GossipStateProviderImpl</span><span class=p>)</span> <span class=nf>commitBlock</span><span class=p>(</span><span class=nx>block</span> <span class=o>*</span><span class=nx>common</span><span class=p>.</span><span class=nx>Block</span><span class=p>,</span> <span class=nx>pvtData</span> <span class=nx>util</span><span class=p>.</span><span class=nx>PvtDataCollections</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 将 block 和 pvtdata 交给 ledger 进行存储
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>ledger</span><span class=p>.</span><span class=nf>StoreBlock</span><span class=p>(</span><span class=nx>block</span><span class=p>,</span> <span class=nx>pvtData</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>logger</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Got error while committing(%+v)&#34;</span><span class=p>,</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>WithStack</span><span class=p>(</span><span class=nx>err</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=privdatacoordinatorstoreblock>privdata.coordinator.StoreBlock<a hidden class=anchor aria-hidden=true href=#privdatacoordinatorstoreblock>#</a></h3><p>文件: <code>gossip/privdata/coordinator.go:163</code></p><p>在这里面会校验 <code>block</code> 的签名, 读写集等, 然后传给 <code>CommitWithPvtData</code> 方法</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>coordinator</span><span class=p>)</span> <span class=nf>StoreBlock</span><span class=p>(</span><span class=nx>block</span> <span class=o>*</span><span class=nx>common</span><span class=p>.</span><span class=nx>Block</span><span class=p>,</span> <span class=nx>privateDataSets</span> <span class=nx>util</span><span class=p>.</span><span class=nx>PvtDataCollections</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>validationStart</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>Validator</span><span class=p>.</span><span class=nf>Validate</span><span class=p>(</span><span class=nx>block</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>c</span><span class=p>.</span><span class=nf>reportValidationDuration</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nf>Since</span><span class=p>(</span><span class=nx>validationStart</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>logger</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Validation failed: %+v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// commit block and private data
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>commitStart</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>CommitWithPvtData</span><span class=p>(</span><span class=nx>blockAndPvtData</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>ledger</span><span class=p>.</span><span class=nx>CommitOptions</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>    <span class=nx>c</span><span class=p>.</span><span class=nf>reportCommitDuration</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nf>Since</span><span class=p>(</span><span class=nx>commitStart</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>Wrap</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;commit failed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=committerledgercommittercommitwithpvtdata>committer.LedgerCommitter.CommitWithPvtData<a hidden class=anchor aria-hidden=true href=#committerledgercommittercommitwithpvtdata>#</a></h3><p>文件: <code>core/committer/committer_impl.go:87</code></p><p>块会交给 <code>kvledger</code> 进行存储, 以下追踪就跟主题无关了, 我把方法列到下面, 有需求可以自己看</p><p>kvledger.kvLedger.CommitWithPvtData: <code>core/ledger/ledgerstorage/store.go:113</code></p><p>fsblkstorage.fsBlockStore.AddBlock: <code>common/ledger/blkstorage/fsblkstorage/fs_blockstore.go:51</code></p><p>fsblkstorage.blockfileMgr.addBlock: <code>common/ledger/blkstorage/fsblkstorage/blockfile_mgr.go:240</code></p><h2 id=额外收获>额外收获<a hidden class=anchor aria-hidden=true href=#额外收获>#</a></h2><h3 id=filelock>fileLock<a hidden class=anchor aria-hidden=true href=#filelock>#</a></h3><p><code>Fabric</code> 中的 <code>ledger management</code> 有一个数据库叫做 <code>fileLock</code>, 最开始不理解为什么要这
么实现,后来读这部分 <code>UnLock</code> 的代码发现, 这是类似于一个君子协议的东西, <code>peer reset</code> 命令里
会打开该数据库, 如果失败就证明有其他程序在使用.</p><p>栗子:</p><p><code>peer node start</code> 启动时会打开 <code>fileLock</code> 的数据库连接, 这时如果你想执行<code>peer reset</code>
这个进程启动是也会去对 <code>fileLock</code> 创建连接, 但是会失败, <code>peer reset</code> 会终止.</p><h3 id=参考>参考<a hidden class=anchor aria-hidden=true href=#参考>#</a></h3><p><a href=https://github.com/hyperledger/fabric/tree/v1.4.7>https://github.com/hyperledger/fabric/tree/v1.4.7</a></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://mioto.me/tags/go/>Go</a></li><li><a href=https://mioto.me/tags/hyperledger-fabric/>Hyperledger Fabric</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://mioto.me>Mioto's Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>